<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Midnight Chat Premium</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Source+Code+Pro:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<style>
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  font-family: 'Inter', sans-serif;
  cursor: default;
}

body {
  display: flex;
  height: 100vh;
  overflow: hidden;
  background: #1a1d21;
  color: #dcddde;
  position: relative;
  transition: background 0.5s ease, color 0.5s ease;
}

button, input {
  cursor: pointer;
}

/* Particle Background */
#particles {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 0;
  opacity: 0.3;
}

/* Sidebar */
#sidebar {
    width: 280px;
    background: linear-gradient(180deg, #1a1b1e 0%, #2b2d31 100%);
    border-right: 1px solid #202225;
    padding: 20px 15px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    position: relative;
    transition: all 0.3s ease;
    box-shadow: 5px 0 15px rgba(0, 0, 0, 0.2);
}

#sidebar h2 {
    color: #fff;
    font-size: 1.2em;
    padding: 15px;
    margin: 0;
    border-bottom: 2px solid rgba(114, 137, 218, 0.2);
    text-transform: uppercase;
    letter-spacing: 1px;
    font-weight: 700;
}

.room-list {
    flex: 1;
    overflow-y: auto;
    padding: 10px 5px;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.room-list::-webkit-scrollbar {
  width: 6px;
}

.room-list::-webkit-scrollbar-thumb {
  background: #7289da;
  border-radius: 10px;
}

.room-btn {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    background: rgba(79, 84, 92, 0.3);
    border: none;
    border-radius: 8px;
    color: #dcddde;
    font-weight: 500;
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
}

.room-btn::before {
    content: '#';
    margin-right: 8px;
    color: #72767d;
    font-weight: 600;
}

.room-btn:hover {
    background: rgba(114, 137, 218, 0.1);
    transform: translateX(4px);
    padding-right: 45px;
}

.room-btn.active {
    background: #7289da;
    color: #fff;
    box-shadow: 0 4px 15px rgba(114, 137, 218, 0.2);
}

.room-btn.active::before {
    color: #fff;
}

.room-controls {
    position: absolute;
    right: 12px;
    display: flex;
    gap: 12px;
    opacity: 0;
    transform: translateX(20px);
    transition: all 0.2s ease;
}

.room-btn:hover .room-controls {
    opacity: 1;
    transform: translateX(0);
}

.edit-room-btn, .delete-room-btn {
    padding: 6px;
    background: transparent;
    border: none;
    color: #dcddde;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
}

.edit-room-btn:hover {
    color: #7289da;
    background: rgba(114, 137, 218, 0.1);
}

.delete-room-btn:hover {
    color: #f04747;
    background: rgba(240, 71, 71, 0.1);
}

#newRoomBtn {
    margin: 10px 5px;
    padding: 12px 20px;
    background: #7289da;
    color: #fff;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.2s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-size: 0.9em;
}

#newRoomBtn::before {
    content: '+';
    font-size: 1.2em;
    font-weight: 400;
}

#newRoomBtn:hover {
    background: #5c6fb1;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(114, 137, 218, 0.3);
}

.unread-badge {
    position: absolute;
    right: 40px;
    top: 50%;
    transform: translateY(-50%);
    background: #f04747;
    color: #fff;
    font-size: 0.8em;
    padding: 2px 6px;
    border-radius: 10px;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: translateY(-50%) scale(1); }
    50% { transform: translateY(-50%) scale(1.1); }
    100% { transform: translateY(-50%) scale(1); }
}

/* Chat Container */
#chat-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: #36393f;
    border-left: 1px solid #202225;
    box-shadow: -3px 0 25px rgba(0, 0, 0, 0.4);
    z-index: 10;
    height: 100vh; /* Add this */
}

/* Update the chat header styles */
#chat-header {
    padding: 15px 25px;
    background: #2f3136;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 15px;
}

.header-right {
    display: flex;
    align-items: center;
    gap: 15px;
}

.user-profile {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 5px 12px;
    background: rgba(79, 84, 92, 0.3);
    border-radius: 20px;
}

.user-profile .avatar {
    width: 32px;
    height: 32px;
    margin: 0;
    border-radius: 50% !important;
}

.user-profile .username {
    color: #fff;
    font-size: 0.9em;
    font-weight: 500;
}

/* Update message bubble styles */
.message-bubble {
    display: flex;
    align-items: flex-start;
    gap: 16px;
    padding: 2px 20px;
    max-width: 95%;
    transition: background-color 0.2s ease;
    border-radius: 4px;
    position: relative;
}

.message-bubble:hover {
    background-color: rgba(4, 4, 5, 0.07);
}

.message-bubble .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50% !important;
    background-size: cover;
    background-position: center;
}

.message-bubble:hover .avatar {
    transform: translateY(-2px);
}

.message-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
    padding: 0;
    background: transparent;
    box-shadow: none;
}

.message-header {
    display: flex;
    align-items: baseline;
    gap: 8px;
}

.message-bubble b {
    color: #fff;
    font-size: 1em;
    font-weight: 500;
    margin: 0;
    opacity: 1;
}

.message-text {
    color: #dcddde;
    font-size: 0.95em;
    line-height: 1.4;
    word-wrap: break-word;
}

.message-bubble .timestamp {
    color: #72767d;
    font-size: 0.75em;
    font-weight: 500;
    margin: 0;
}

/* Self Messages */
.message-bubble.self {
    flex-direction: row-reverse;
    align-self: flex-end;
}

.message-bubble.self .message-content {
    align-items: flex-end;
}

.message-bubble.self .message-header {
    flex-direction: row-reverse;
}

.message-bubble.self b {
    color: #7289da;
}

/* Images in Messages */
.message-text img {
    max-width: 400px;
    max-height: 300px;
    border-radius: 8px;
    margin: 4px 0;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

/* Message Groups */
.message-bubble + .message-bubble {
    margin-top: 2px;
}

/* Typing Indicator */
#typing-indicator {
  padding: 5px 20px;
  min-height: 24px;
  font-size: 0.9em;
  color: #72767d;
  margin-left: 15px;
  height: 20px;
  font-family: 'Source Code Pro', monospace;
  font-style: italic;
  display: flex;
  align-items: center;
  gap: 8px;
}

.typing-dot {
  width: 8px;
  height: 8px;
  background: #7289da;
  border-radius: 50%;
  animation: typingAnim 1.4s ease-in-out infinite;
}

.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes typingAnim {
  0%, 100% { transform: translateY(0); opacity: 0.5; }
  50% { transform: translateY(-5px); opacity: 1; }
}

/* Input Container */
#input-container {
    display: flex;
    padding: 20px;
    background: #2f3136;
    border-top: 1px solid rgba(255, 255, 255, 0.05);
    gap: 12px;
    margin-top: auto; /* Add this */
}

#message {
    flex: 1;
    padding: 12px 20px;
    border-radius: 24px;
    border: 2px solid rgba(114, 137, 218, 0.2);
    background: #40444b;
    color: #dcddde;
    font-size: 0.95em;
    transition: all 0.3s ease;
    cursor: text;
}

#message:focus {
    outline: none;
    border-color: #7289da;
    background: #42464d;
    box-shadow: 0 0 15px rgba(114, 137, 218, 0.2);
}

button.send-btn, .file-btn {
    padding: 12px 24px;
    border-radius: 24px;
    background: #7289da;
    color: #fff;
    font-weight: 500;
    font-size: 0.9em;
    transition: all 0.2s ease;
    border: none;
}

button.send-btn:hover, .file-btn:hover {
    background: #5c6fb1;
    transform: translateY(-1px);
}

/* File Input Styling */
.file-btn-wrapper {
    position: relative;
    overflow: hidden;
    display: inline-block;
}

.file-btn-wrapper input[type=file] {
    position: absolute;
    left: 0;
    top: 0;
    opacity: 0;
    width: 100%;
    height: 100%;
    cursor: pointer;
}

.file-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
}

.file-btn::before {
    content: 'ðŸ“Ž';
    font-size: 1.2em;
}

/* User Status */
.user-status {
  font-size: 0.8em;
  color: #43b581;
  margin-left: 10px;
}

.message-bubble b {
    cursor: default !important;
}

.message-bubble {
    cursor: default !important;
}

/* Timestamps */
.message-bubble .timestamp {
    font-size: 0.7em;
    color: rgba(255, 255, 255, 0.3);
    margin-top: 4px;
    display: inline-block;
}

/* Scrollbar */
::-webkit-scrollbar {
    width: 8px;
}

::-webkit-scrollbar-track {
    background: #2f3136;
}

::-webkit-scrollbar-thumb {
    background: #202225;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: #7289da;
}

/* Room Controls */
.room-controls {
    display: flex;
    gap: 5px;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.room-btn:hover .room-controls {
    opacity: 1;
}

.edit-room-btn, .delete-room-btn {
    padding: 6px;
    font-size: 14px;
    background: transparent;
    border: none;
    color: #dcddde;
    transition: all 0.2s ease;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
}

.edit-room-btn:hover {
    color: #7289da;
}

.delete-room-btn:hover {
    color: #f04747;
}

.room-name {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Update the chat header HTML structure */
#chat-header {
    padding: 15px 25px;
    background: #2f3136;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 15px;
}

.header-right {
    display: flex;
    align-items: center;
    gap: 15px;
}

.user-profile {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 5px 12px;
    background: rgba(79, 84, 92, 0.3);
    border-radius: 20px;
}

.user-profile .avatar {
    width: 32px;
    height: 32px;
    margin: 0;
    border-radius: 50% !important;
}

.user-profile .username {
    color: #fff;
    font-size: 0.9em;
    font-weight: 500;
}

/* Update the avatar styles for all instances */
.avatar {
    width: 40px;
    height: 40px;
    border-radius: 50% !important;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    color: white;
    background: #7289da;
    flex-shrink: 0;
    text-transform: uppercase;
    font-size: 16px;
    border: 2px solid rgba(255, 255, 255, 0.1);
    transition: transform 0.2s ease;
}

.avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
}

/* Update avatar preview in welcome modal */
#avatar-preview {
    width: 100px;
    height: 100px;
    border-radius: 50% !important;
    overflow: hidden;
    background-size: cover;
    background-position: center;
}
</style>
</head>
<body>
<div id="particles"></div>
<div id="sidebar">
<h2>Chat Rooms</h2>
<div id="roomList" class="room-list"></div>
<button id="newRoomBtn" class="file-btn">+ Create Room</button>
</div>
<div id="chat-container">
<div id="chat-header">
    <div class="header-left">
        <span id="current-room">Main</span>
    </div>
    <div class="header-right">
        <div class="user-profile">
            <div class="avatar" id="header-avatar">
                <i class="fas fa-user"></i>
            </div>
            <span class="username" id="header-username"></span>
        </div>
        <span class="user-status" id="user-status">Online</span>
    </div>
</div>
<div id="messages"></div>
<div id="typing-indicator"></div>
<div id="input-container">
<input type="text" id="message" placeholder="Type a message...">
<div class="file-btn-wrapper">
<button class="file-btn">Choose File</button>
<input type="file" class="file-input" id="fileInput">
</div>
<button class="send-btn" id="sendBtn">Send</button>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/particles.js/2.0.0/particles.min.js"></script>
<script>
// Add these variables at the start of your script
let currentRoom = 'Main';
let rooms = [];
let isAdmin = false;
const ADMIN_COMMAND = '/auth';
const messagesDiv = document.getElementById('messages');
const roomListDiv = document.getElementById('roomList');
const chatHeader = document.getElementById('current-room');
const messageInput = document.getElementById('message');
const sendBtn = document.getElementById('sendBtn');
const fileInput = document.getElementById('fileInput');
const newRoomBtn = document.getElementById('newRoomBtn');
const typingIndicator = document.getElementById('typing-indicator');
const userStatus = document.getElementById('user-status');
let username;
let userAvatar;

// Initialize socket with error handling
const socket = io('http://localhost:3000', {
    reconnection: true,
    reconnectionAttempts: 5,
    reconnectionDelay: 1000,
    transports: ['websocket']
});

// Replace the username prompt with this function
async function initializeUser() {
    return new Promise((resolve) => {
        const modalHtml = `
            <div id="welcome-modal" style="
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            ">
                <div style="
                    background: #36393f;
                    padding: 30px;
                    border-radius: 10px;
                    box-shadow: 0 0 20px rgba(0,0,0,0.5);
                    width: 90%;
                    max-width: 400px;
                ">
                    <h2 style="color: #fff; margin-bottom: 20px;">Welcome to Midnight Chat</h2>
                    <div style="margin-bottom: 20px;">
                        <label style="color: #b9bbbe; display: block; margin-bottom: 8px;">Username</label>
                        <input type="text" id="username-input" style="
                            width: 100%;
                            padding: 10px;
                            border-radius: 4px;
                            border: 1px solid #202225;
                            background: #40444b;
                            color: #fff;
                            box-sizing: border-box;
                            cursor: text;
                        " placeholder="Enter your username">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="color: #b9bbbe; display: block; margin-bottom: 8px;">Profile Picture</label>
                        <input type="file" id="avatar-input" accept="image/*" style="display: none;">
                        <div id="avatar-preview" style="
                            width: 100px;
                            height: 100px;
                            border-radius: 50%;
                            background: #202225;
                            margin: 0 auto;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            cursor: pointer;
                            border: 2px solid #7289da;
                        ">
                            <i class="fas fa-user" style="color: #7289da; font-size: 40px;"></i>
                        </div>
                        <p style="color: #72767d; text-align: center; margin-top: 8px;">Click to choose image</p>
                    </div>
                    <button id="start-chat-btn" style="
                        width: 100%;
                        padding: 12px;
                        background: #7289da;
                        color: #fff;
                        border: none;
                        border-radius: 4px;
                        font-weight: 600;
                        cursor: pointer;
                    ">Start Chatting</button>
                </div>
            </div>
        `;

        // Add modal to page
        document.body.insertAdjacentHTML('beforeend', modalHtml);

        const modal = document.getElementById('welcome-modal');
        const usernameInput = document.getElementById('username-input');
        const avatarInput = document.getElementById('avatar-input');
        const avatarPreview = document.getElementById('avatar-preview');
        const startButton = document.getElementById('start-chat-btn');

        // Handle avatar selection
        avatarPreview.addEventListener('click', () => avatarInput.click());
        
        avatarInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                // Show preview
                const reader = new FileReader();
                reader.onload = (e) => {
                    avatarPreview.innerHTML = '';
                    avatarPreview.style.backgroundImage = `url(${e.target.result})`;
                    avatarPreview.style.backgroundSize = 'cover';
                    avatarPreview.style.backgroundPosition = 'center';
                };
                reader.readAsDataURL(file);

                // Upload file
                const formData = new FormData();
                formData.append('file', file);
                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    userAvatar = data.filePath;
                } catch (err) {
                    alert('Failed to upload avatar');
                }
            }
        });

        // Handle form submission
        startButton.addEventListener('click', () => {
            const name = usernameInput.value.trim();
            if (!name) {
                alert('Please enter a username');
                return;
            }
            username = name;
            updateUserProfile(username, userAvatar);
            modal.remove();
            resolve();
        });

        // Handle enter key in username input
        usernameInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                startButton.click();
            }
        });

        // Focus username input
        usernameInput.focus();
    });
}

// Add this function to update user profile
function updateUserProfile(username, avatarUrl) {
    const headerAvatar = document.getElementById('header-avatar');
    const headerUsername = document.getElementById('header-username');
    
    headerUsername.textContent = username;
    
    if (avatarUrl) {
        headerAvatar.innerHTML = '';
        headerAvatar.style.backgroundImage = `url(${avatarUrl})`;
        headerAvatar.style.backgroundSize = 'cover';
        headerAvatar.style.backgroundPosition = 'center';
    } else {
        headerAvatar.innerHTML = `<i class="fas fa-user"></i>`;
    }
}

// Update the initialization sequence
async function initializeChat() {
    await initializeUser();
    socket.emit('joinRoom', 'Main');
    socket.emit('getRooms');
}

// Call the initialization function
initializeChat();

// Hide new room button by default
newRoomBtn.style.display = 'none';

// Add this helper function at the top with other functions
function getInitials(name) {
    return name
        .split(' ')
        .map(word => word[0])
        .join('')
        .toUpperCase()
        .slice(0, 2);
}

// Replace the existing addMessage function
function addMessage(msg) {
    if (msg.room !== currentRoom) return;
    
    const el = document.createElement('div');
    el.className = 'message-bubble' + (msg.username === username ? ' self' : '');
    
    // Create avatar
    const avatarDiv = document.createElement('div');
    avatarDiv.className = 'avatar';
    
    if (msg.username === username && userAvatar) {
        avatarDiv.style.backgroundImage = `url(${userAvatar})`;
        avatarDiv.style.backgroundSize = 'cover';
        avatarDiv.style.backgroundPosition = 'center';
    } else {
        avatarDiv.textContent = getInitials(msg.username);
    }
    
    // Create message content
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    
    // Create message header
    const headerDiv = document.createElement('div');
    headerDiv.className = 'message-header';
    
    const usernameSpan = document.createElement('b');
    usernameSpan.textContent = msg.username;
    
    const timestampSpan = document.createElement('span');
    timestampSpan.className = 'timestamp';
    timestampSpan.textContent = new Date(msg.timestamp).toLocaleTimeString();
    
    headerDiv.appendChild(usernameSpan);
    headerDiv.appendChild(timestampSpan);
    
    // Create message text
    const messageText = document.createElement('div');
    messageText.className = 'message-text';
    messageText.innerHTML = msg.message;
    
    // Assemble message
    contentDiv.appendChild(headerDiv);
    contentDiv.appendChild(messageText);
    
    el.appendChild(avatarDiv);
    el.appendChild(contentDiv);
    
    messagesDiv.appendChild(el);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// Add socket event handler for messages
socket.on('message', (msg) => {
    addMessage(msg);
});

// Update the sendMessage function
function sendMessage() {
    const msg = messageInput.value.trim();
    if (!msg) return;
    
    if (msg.startsWith(ADMIN_COMMAND)) {
        const password = prompt('Enter admin password:');
        if (password) {
            socket.emit('authenticateAdmin', password, (response) => {
                if (response.success) {
                    isAdmin = true;
                    alert('Admin privileges granted!');
                    document.querySelectorAll('.room-controls').forEach(controls => {
                        if (!controls.parentElement.querySelector('.room-name').textContent.includes('Main')) {
                            controls.style.display = 'flex';
                        }
                    });
                    newRoomBtn.style.display = 'flex';
                } else {
                    alert('Invalid password!');
                }
            });
        }
        messageInput.value = '';
        return;
    }

    const messageData = {
        username,
        message: msg,
        room: currentRoom,
        timestamp: Date.now()
    };

    socket.emit('chatMessage', messageData);
    messageInput.value = '';
}

// Update the message input event listener
messageInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    } else {
        socket.emit('typing', { room: currentRoom, username });
        clearTimeout(window.typingTimeout);
        window.typingTimeout = setTimeout(() => {
            socket.emit('stopTyping', { room: currentRoom, username });
        }, 1000);
    }
});

sendBtn.addEventListener('click', sendMessage);

// File handling
fileInput.addEventListener('change', () => {
    const file = fileInput.files[0];
    if (!file) return;
    
    const formData = new FormData();
    formData.append('file', file);
    
    const sendBtn = document.querySelector('.send-btn');
    sendBtn.disabled = true;
    sendBtn.textContent = 'Uploading...';
    
    fetch('/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) throw new Error('Upload failed');
        return response.json();
    })
    .then(data => {
        socket.emit('chatMessage', {
            username,
            message: `<img src="${data.filePath}">`,
            room: currentRoom,
            timestamp: Date.now()
        });
    })
    .catch(err => alert('Failed to upload file'))
    .finally(() => {
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send';
        fileInput.value = '';
    });
});

// New room creation
newRoomBtn.onclick = () => {
    const roomName = prompt('Enter room name:');
    if (!roomName) return;
    socket.emit('createRoom', roomName);
    addRoomButton(roomName);
    joinRoom(roomName);
};

// Update the addRoomButton function
function addRoomButton(roomName) {
    const btn = document.createElement('button');
    btn.className = 'room-btn';
    
    // Create room name span
    const nameSpan = document.createElement('span');
    nameSpan.className = 'room-name';
    nameSpan.textContent = roomName;
    
    // Create controls container
    const controls = document.createElement('div');
    controls.className = 'room-controls';
    controls.style.display = isAdmin && roomName !== 'Main' ? 'flex' : 'none';
    
    // Create edit button
    const editBtn = document.createElement('button');
    editBtn.className = 'edit-room-btn';
    editBtn.innerHTML = '<i class="fas fa-pen"></i>';
    editBtn.onclick = (e) => {
        e.stopPropagation();
        if (isAdmin && roomName !== 'Main') {
            editRoom(roomName, editBtn);
        }
    };
    
    // Create delete button
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'delete-room-btn';
    deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
    deleteBtn.onclick = (e) => {
        e.stopPropagation();
        if (isAdmin && roomName !== 'Main') {
            deleteRoom(roomName, deleteBtn);
        }
    };
    
    controls.appendChild(editBtn);
    controls.appendChild(deleteBtn);
    
    const badge = document.createElement('span');
    badge.className = 'unread-badge';
    badge.style.display = 'none';
    
    btn.appendChild(nameSpan);
    btn.appendChild(controls);
    btn.appendChild(badge);
    
    btn.onclick = () => {
        joinRoom(roomName);
        badge.style.display = 'none';
    };
    
    roomListDiv.appendChild(btn);
    rooms.push({ name: roomName, badge });
}

// Update the joinRoom function
function joinRoom(roomName) {
    socket.emit('leaveRoom', currentRoom);
    currentRoom = roomName;
    chatHeader.textContent = roomName;
    messagesDiv.innerHTML = '';
    
    document.querySelectorAll('.room-btn').forEach(btn => {
        const name = btn.querySelector('.room-name').textContent;
        if (name === roomName) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
    
    socket.emit('joinRoom', roomName);
}

// Update socket connection initialization
socket.on('connect', () => {
    userStatus.textContent = 'Online';
    userStatus.style.color = '#43b581';
    // Don't emit joinRoom here, it's handled in initializeChat
});

// Update initializeChat function
async function initializeChat() {
    await initializeUser();
    
    // Get initial room list
    fetch('/rooms')
        .then(response => response.json())
        .then(serverRooms => {
            roomListDiv.innerHTML = '';
            rooms = serverRooms;
            serverRooms.forEach(room => addRoomButton(room));
            joinRoom('Main'); // Join main room after loading rooms
        })
        .catch(error => {
            console.error('Error loading rooms:', error);
            // Fallback to basic room setup
            addRoomButton('Main');
            joinRoom('Main');
        });
}

// Add room event handlers
socket.on('roomCreated', (roomName) => {
    addRoomButton(roomName);
});

socket.on('roomDeleted', (roomName) => {
    const roomBtn = Array.from(document.querySelectorAll('.room-btn'))
        .find(btn => btn.querySelector('.room-name').textContent === roomName);
    if (roomBtn) {
        roomBtn.remove();
        if (currentRoom === roomName) {
            joinRoom('Main');
        }
    }
});

socket.on('roomUpdated', ({oldName, newName}) => {
    const roomBtn = Array.from(document.querySelectorAll('.room-btn'))
        .find(btn => btn.querySelector('.room-name').textContent === oldName);
    if (roomBtn) {
        roomBtn.querySelector('.room-name').textContent = newName;
        if (currentRoom === oldName) {
            currentRoom = newName;
            chatHeader.textContent = newName;
        }
    }
});

// Add these functions for room management
function editRoom(oldName, btn) {
    if (oldName === 'Main') return;
    
    const newName = prompt('Enter new room name:', oldName);
    if (!newName || newName === oldName || newName === 'Main') return;

    socket.emit('editRoom', { oldName, newName }, (success) => {
        if (success) {
            if (currentRoom === oldName) {
                currentRoom = newName;
                chatHeader.textContent = newName;
            }
            // Update room button
            const roomBtn = btn.closest('.room-btn');
            const roomNameEl = roomBtn.querySelector('.room-name');
            roomNameEl.textContent = newName;
            
            // Update rooms array
            const room = rooms.find(r => r.name === oldName);
            if (room) room.name = newName;
        } else {
            alert('Failed to edit room name');
        }
    });
}

function deleteRoom(roomName, btn) {
    if (roomName === 'Main') return;
    
    if (!confirm(`Are you sure you want to delete the room "${roomName}"?`)) return;

    socket.emit('deleteRoom', roomName, (success) => {
        if (success) {
            btn.closest('.room-btn').remove();
            rooms = rooms.filter(r => r.name !== roomName);
            if (currentRoom === roomName) {
                joinRoom('Main');
            }
        } else {
            alert('Failed to delete room');
        }
    });
}

// Add these socket event listeners
socket.on('roomEdited', ({oldName, newName}) => {
    const roomBtn = Array.from(document.querySelectorAll('.room-btn'))
        .find(btn => btn.querySelector('.room-name').textContent === oldName);
    if (roomBtn) {
        roomBtn.querySelector('.room-name').textContent = newName;
        if (currentRoom === oldName) {
            currentRoom = newName;
            chatHeader.textContent = newName;
        }
    }
});

socket.on('roomDeleted', (roomName) => {
    const roomBtn = Array.from(document.querySelectorAll('.room-btn'))
        .find(btn => btn.querySelector('.room-name').textContent === roomName);
    if (roomBtn) {
        roomBtn.remove();
        if (currentRoom === roomName) {
            joinRoom('Main');
        }
    }
});

// Add avatar upload button to chat header
document.querySelector('#chat-header').innerHTML += `
    <button onclick="uploadAvatar()" class="avatar-btn" title="Change Avatar" style="
        background: transparent;
        border: none;
        color: #7289da;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    ">
        <i class="fas fa-user-circle"></i>
    </button>
`;

// Make sure rooms are loaded initially
socket.emit('getRooms');

// Update your server.js socket connection handler
io.on('connection', (socket) => {
    socket.on('joinRoom', (room) => {
        socket.join(room);
    });

    socket.on('leaveRoom', (room) => {
        socket.leave(room);
    });

    socket.on('chatMessage', (msg) => {
        io.to(msg.room).emit('message', msg);
    });

    socket.on('typing', (data) => {
        socket.to(data.room).emit('typing', data);
    });

    socket.on('stopTyping', (data) => {
        socket.to(data.room).emit('stopTyping', data);
    });
});
</script>
</body>
</html>